{% extends "base/base.html" %}

{% load staticfiles %}

{% block content %}

    <h1 class="page-header">
        Battle test
        <a href="#" onclick="do_prev_turn()" class="btn btn-default">PREV</a>
        <a href="#" onclick="do_next_turn()" class="btn btn-default">NEXT</a>
    </h1>

    <iframe
            id="battlefield_map"
            class="placeholder"
            scrolling="no"
            style="height: 700px; width: 100%; padding: 0; border: 0;"
            src="{% url 'battle:battlefield_iframe' battle.id %}"
    ></iframe>
<!--
    <script src="{% static 'world/3rd/three.min.js' %}"></script>
    <script src="{% static 'world/3rd/Tween.js' %}"></script>
    <script src="{% static 'world/3rd/OrbitControls.js' %}"></script>


    <script type="text/javascript">

        var battle_data = {{ battle_data|safe }};
        var unit_data = battle_data.unit_data;
        var object_data = battle_data.object_data;
        var height_map = battle_data.heightmap;
        var turn = 0;
        var prev_turn = 0;

        function do_prev_turn() {
            if (turn === 0) return;
            prev_turn = turn;
            turn -= 1;
            turn_animation();
        }

        function do_next_turn() {
            prev_turn = turn;
            turn += 1;
            turn_animation();
        }

        function tween_updater_creator(unit) {
            return function()
            {
                unit.mesh.position.x = unit.tween_data.position.x;
                unit.mesh.position.z = unit.tween_data.position.z;
            }
        }

        function turn_animation() {
            TWEEN.removeAll();
            for (var i = 0; i < unit_data.length; i++)  {
                var unit = unit_data[i];

                unit.tween_data = {};
                unit.tween_data.position = { x : unit.turn_data[prev_turn].x_pos-50, z: unit.turn_data[prev_turn].z_pos-50 };
                unit.tween_data.target = { x : unit.turn_data[turn].x_pos-50, z: unit.turn_data[turn].z_pos-50 };
                unit.tween = new TWEEN.Tween(unit.tween_data.position);
                unit.tween.to(unit.tween_data.target, 500);
                unit.tween.onUpdate(tween_updater_creator(unit));
                unit.tween.start();
            }
        }

        $(function () {

            //scene
            var scene = new THREE.Scene();
            //camera
            var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 0;
            camera.position.x = 25;
            camera.position.y = 25;
            camera.lookAt(new THREE.Vector3( 0, 0, 0 ));
            camera.aspect = (window.innerWidth - 30) / (window.innerHeight-300);
            camera.updateProjectionMatrix();

            //renderer
            var renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth - 30, window.innerHeight-300);
            //controls
            var controls = new THREE.OrbitControls(camera, renderer.domElement);
            //axes
            var axes = new THREE.AxisHelper(2);
            scene.add(axes);
            //grid xz
            var gridXZ = new THREE.GridHelper(10, 1);
            scene.add(gridXZ);
            //ambient light
            var ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
            scene.add(ambientLight);
            //directional light
            var directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(1, 1, 1).normalize();
            scene.add(directionalLight);
            // point light
            //var pointLight = new THREE.PointLight(0xffffff, 10);
            //pointLight.position.set(0, 10, 30);
            //scene.add(pointLight);

            //show canvas
            $("#canvas-container").html(renderer.domElement);

            // plane
            var geometry = new THREE.PlaneGeometry(100, 100, 9 ,9);
            //var texture = THREE.ImageUtils.loadTexture('{% static 'battle/texture.png' %}');
            //var material = new THREE.MeshLambertMaterial({map: texture});
            var material = new THREE.MeshLambertMaterial({color: 0x229922});

            var plane = new THREE.Mesh(geometry, material);

            //set height of vertices
            for (var i = 0; i < plane.geometry.vertices.length; i++) {
                plane.geometry.vertices[i].z = height_map[i];
            }
            plane.rotateX(- Math.PI / 2);
            plane.position.y = 0;
            geometry.computeFaceNormals();
            geometry.computeVertexNormals();

            scene.add(plane);

            var unit_geometry = new THREE.CubeGeometry(1, 1, 1);
            var unit_material = new THREE.MeshLambertMaterial({color: 0x0000ff, shading: THREE.SmoothShading});
            for (var i = 0; i < unit_data.length; i++)  {
                var unit = unit_data[i].turn_data[0];
                var cube = new THREE.Mesh(unit_geometry, unit_material);
                cube.position.x = unit.x_pos - 50;
                cube.position.z = unit.z_pos - 50;
                cube.position.y = 0.5;
                unit_data[i].mesh = cube;
                scene.add(cube);
            }

            var object_geometry = new THREE.CubeGeometry(1, 3, 1);
            var object_material = new THREE.MeshLambertMaterial({color: 0xbbbbbb, shading: THREE.SmoothShading});
            for (var i = 0; i < object_data.length; i++)  {
                var object = object_data[i].turn_data[0];
                var cube = new THREE.Mesh(object_geometry, object_material);
                cube.position.x = object.x_pos - 50;
                cube.position.z = object.z_pos - 50;
                cube.position.y = 1.5;
                object_data[i].mesh = cube;
                scene.add(cube);
            }

            //render scene
            var render = function () {
                requestAnimationFrame(render);
                renderer.render(scene, camera);
            };

            function animate(){
                requestAnimationFrame(animate);
                TWEEN.update();
            }

            animate();
            render();

        });

    </script>

    <div id="canvas-container"></div>
    -->

{% endblock %}
